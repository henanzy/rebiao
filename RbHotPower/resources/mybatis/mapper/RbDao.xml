<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "http://mybatis.org/dtd/mybatis-3-mapper.dtd" "mybatis-3-mapper.dtd" >
<mapper namespace="com.hnzy.rb.dao.RbDao">
	<resultMap type="Rb" id="rb">
		<result property="yh.id" column="ID" />
		<result property="yh.yhName" column="YhName" />
		<result property="yh.xqName" column="XqName" />
		<result property="yh.rbLyName" column="RbLyName" />
		<result property="yh.cellNO" column="CellNO" />
		<result property="yh.houseNO" column="HouseNO" />
		<result property="yh.rbAd" column="RbAd" />
		<result property="yh.bz" column="Bz" />
		<result property="yh.Rblb" column="Rblb" />
		<result property="yh.rbfl" column="Rbfl"/>
		<result property="yh.AZWZ" column="AZWZ"></result>
		<result property="yh.resNum" column="ResNum"></result>
		<result property="rbType" column="RbType" />
		<result property="rbAd" column="RbAd" />	
		<result property="energy" column="Energy" />
		<result property="energyLj" column="EnergyLj" />
		<result property="energyUnit" column="EnergyUnit" />
		<result property="power" column="Power" />
		<result property="flow" column="Flow" />
		<result property="inTmp" column="In_Tmp" />
		<result property="outTmp" column="Out_Tmp" />
		<result property="diffTmp" column="Diff_Tmp" />
		<result property="operTime" column="OperTime" />
		<result property="errCode" column="ErrCode" />
		<result property="readMTime" column="ReadMTime" />
		<result property="recordTime" column="RecordTime" />	
		<result property="rlc" column="Rlc"/>	
		<result property="status" column="status"/>	
		<result property="bz" column="Bz"/>	
		<!-- 楼宇号 -->
		<result property="yh.buildNO" column="BuildNO"/>
		<result property="qgId" column="QgID"/>
		<result property="qg.qgID" column="qgID"/>
		<result property="qg.jzqID" column="jzqID"/>
		<result property="qg.jzq.jzqIp" column="jzqIp"/>
		<result property="qg.jzq.jzqPort" column="jzqPort"/>
	</resultMap>
<!-- socket 微信根据阀门地址查找信息 -->
<!-- <select id="findWxxByFmId" resultMap="rb" parameterType="Rb">
select distinct fm.HTemSet,fm.MTemSet,fm.LTemSet,fm.QgID,jzq.JzqIP,jzq.JzqPort
			 from T_FmInfo fm,T_QgInfo qg,T_JzqInfo jzq 
			 where fm.QgID=qg.QgID and qg.JzqID=jzq.JzqID and fm.ValAd=#{fmId}
</select> -->
<!-- socket更新热表信息 -->
<update id="updateRbById" parameterType="Rb">
update T_RbInfo set Energy=#{energy},EnergyLj=#{energyLj},power=#{power},flow=#{flow},In_Tmp=#{inTmp},OperTime=#{operTime},
Out_Tmp=#{outTmp},RecordTime=#{recordTime} ,ReadMTime=#{readMTime},status=#{status},Diff_Tmp=#{diffTmp}  where RbAd=#{rbAd}
</update>
<insert id="InsertRbHis">
<!-- socket更插入历史热表信息 -->
insert into T_RbHistory (RbAd,Energy,EnergyLj,power,flow,In_Tmp,Out_Tmp,OperTime,ReadMTime,RecordTime,status,Diff_Tmp)values (
       #{rbAd},#{energy} , #{energyLj},#{power},#{flow},#{inTmp},#{outTmp},#{operTime},#{readMTime},#{recordTime},#{status},#{diffTmp})
</insert>
<select id="findRbAll" resultMap="rb" parameterType="Rb">
		Select distinct 
		y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.Rbfl,
		y.Bz,
		y.RbLyName,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.RbExp,
		r.status,
		y.Rbfl
		from T_YhInfo y,T_RbInfo  r
		where y.RbAd=r.RbAd 
		<if test="rbfl!=2">
		  and  Rbfl=#{rbfl}
		</if>
	<!-- 	 and y.Rbfl=0 -->
		<if test="xqName!='--选择小区名称--' and xqName!=''">
		  and  XqName=#{xqName}
		</if>
		<if test="rbLyName!=null and rbLyName!=''">
		  and  RbLyName=#{rbLyName}
		</if>
		<if test="cellNO!=null and cellNO!=''">
		  and  CellNO=#{cellNO}
		</if>
		<if test="houseNO!=null and houseNO!=''">
		  and  HouseNO=#{houseNO}
		</if>
	</select>

	<select id="findRb" resultMap="rb" parameterType="Rb">
		Select distinct 
		y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.Rbfl,
		y.Bz,
		y.RbLyName,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.RbExp,
		r.status
		from T_YhInfo y,T_RbInfo  r
		where y.RbAd=r.RbAd  and y.Rbfl=0
		<if test="xqName!='--选择小区名称--' and xqName!=''">
		  and  XqName=#{xqName}
		</if>
		<if test="rbLyName!=null and rbLyName!=''">
		  and  RbLyName=#{rbLyName}
		</if>
		<if test="cellNO!=null and cellNO!=''">
		  and  CellNO=#{cellNO}
		</if>
		<if test="houseNO!=null and houseNO!=''">
		  and  HouseNO=#{houseNO}
		</if>
	</select>
   <select id="find"  resultMap="rb" parameterType="Rb">
   		Select 
   		y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.Rbfl,
		y.RbLyName,
		y.ResNum,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.RbExp,
		y.Bz,
		y.Rbfl,
		r.status,
		y.Bz
		from T_YhInfo y,T_RbInfo  r
		where y.RbAd=r.RbAd and y.XqName='市政小区' and y.Rbfl=0  order by BuildNO
   </select>
   <select id="searchSbb"  resultMap="rb" parameterType="Rb">
       Select distinct
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.Rbfl,
		y.rbfl,
		y.RbLyName,
		y.ResNum,
		r.bz,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.status,
		r.RbExp,
		y.Bz
		from T_YhInfo y,T_RbInfo  r
		where y.RbAd=r.RbAd 
		<if test="xqName!='--选择小区名称--' and xqName!=''">
		  and  XqName=#{xqName}
		</if>
		<if test="rbLyName!=null and rbLyName!=''">
		  and  RbLyName=#{rbLyName}
		</if>
		<if test="cellNo!=null and cellNo!=''">
		  and  CellNO=#{cellNo}
		</if>
		<if test="houseNo!=null and houseNo!=''">
		  and  HouseNO=#{houseNo}
		</if>
   		<if test="recordTime1!=null and recordTime1!=''">
		  and r.recordTime &gt;= #{recordTime1}
		</if>
		<if test="recordTime2!=null and recordTime2!=''">
		  and r.recordTime &lt;=#{recordTime2}
		</if>
		<if test="rbfl!=2">
		  and  Rbfl=#{rbfl}
		</if>
   </select>
   <select id="searchHis"  resultMap="rb" parameterType="Rb">
       Select top 1500
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.Rbfl,
		y.RbLyName,
		y.Rblb,
		y.ResNum,
		r.RbType,
		r.RbAd,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.RbExp,
		r.status,
		y.Bz
		from T_YhInfo y,T_RbHistory  r
		where y.RbAd=r.RbAd
		<if test="xqName!='--选择小区名称--' and xqName!=''">
		  and  XqName=#{xqName}
		</if>
		<if test="rbLyName!=null and rbLyName!=''">
		  and  RbLyName=#{rbLyName}
		</if>
		<if test="cellNo!=null and cellNo!=''">
		  and  CellNO=#{cellNo}
		</if>
		<if test="houseNo!=null and houseNo!=''">
		  and  HouseNO=#{houseNo}
		</if>
   		<if test="recordTime1!=null and recordTime1!=''">
		  and r.recordTime &gt;= #{recordTime1}
		</if>
		<if test="recordTime2!=null and recordTime2!=''">
		  and r.recordTime &lt;=#{recordTime2}
		</if>
    	order by   BuildNO ,CellNO ,HouseNO ,RecordTime desc
   </select >
   <select id="searchHisExcel"  resultMap="rb" parameterType="Rb">
       Select
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.Rbfl,
		y.RbLyName,
		y.Rblb,
		r.RbType,
		r.RbAd,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.status,
		y.Bz
		from T_YhInfo y,T_RbHistory  r
		where y.RbAd=r.RbAd
		<if test="xqName!='--选择小区名称--' and xqName!=''">
		  and  XqName=#{xqName}
		</if>
		<if test="rbLyName!=null and rbLyName!=''">
		  and  RbLyName=#{rbLyName}
		</if>
		<if test="cellNo!=null and cellNo!=''">
		  and  CellNO=#{cellNo}
		</if>
		<if test="houseNo!=null and houseNo!=''">
		  and  HouseNO=#{houseNo}
		</if>
   		<if test="recordTime1!=null and recordTime1!=''">
		  and r.recordTime &gt;= #{recordTime1}
		</if>
		<if test="recordTime2!=null and recordTime2!=''">
		  and r.recordTime &lt;=#{recordTime2}
		</if>
       order by   BuildNO ,CellNO ,HouseNO ,RecordTime desc
   </select >
   <select id="SbSelExp" resultMap="rb" parameterType="Rb">
    Select   top 1500
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.RbLyName,
		y.Rbfl,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.status,
		y.Bz
		from T_YhInfo y,T_RbInfo  r
		where y.RbAd=r.RbAd  and Rbfl=0
		<if test="gs!=null and gs!=''">
		  and  In_Tmp &gt;=#{gs}
		</if>
   		<if test="hs!=null and hs!=''">
		  and  Out_Tmp &gt;=#{hs}
		</if>
		<if test="wc!=0 and wc!=''">
		  and Diff_Tmp &lt; 0
		</if>

   </select>
   <select id="SelRbEp" resultMap="rb">
		select top 2  r.Diff_Tmp,r.Energy,r.In_Tmp,r.Out_Tmp,r.Flow,r.Power,r.OperTime from T_RbHistory r where RbAd=#{rbAd} order by RecordTime desc
		</select>
		<select id="SelRbExp" resultMap="rb">
	    select rb.RbAd,rb.Diff_Tmp from T_RbInfo rb,T_YhInfo yh where rb.RbAd=yh.RbAd  and yh.Rbfl=0  and rb.RbAd is not null and Energy >'0.00'
		</select>
		<update id="UpExp" parameterType="Rb" >
		update T_RbInfo set RbExp=#{rbExp} where RbAd=#{rbAd}
		</update>
		<select id="findById" resultMap="rb" parameterType="Rb">
		select 
		y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.RbAd,
		y.Rbfl,
		y.RbLyName,
		y.Bz
		from T_YhInfo y where y.id=#{id}
		</select>
		<update id="UpSbxx" parameterType="Rb">
		 update T_YhInfo set YhName=#{yh.yhName},RbAd=#{rbAd}, Rbfl=#{yh.rbfl},Bz=#{yh.bz}  where XqName=#{yh.xqName} and RbLyName=#{yh.rbLyName} and CellNo=#{yh.cellNO} and HouseNO=#{yh.houseNO} 
		</update>
		<update id="UpRbVal" parameterType="Rb">
		 update T_RbInfo set RbAd=#{rbAd} where RbAd=(select RbAd from T_YhInfo  where XqName=#{yh.xqName} and RbLyName=#{yh.rbLyName} and CellNo=#{yh.cellNO} and HouseNO=#{yh.houseNO})
		</update>
		<select id="findByRbAd" resultMap="rb" parameterType="Rb">
		select distinct rb.RbAd,yh.XqName,yh.BuildNO,yh.CellNo,yh.HouseNo,yh.Rblb, qg.QgID,jzq.JzqIP,jzq.JzqPort
 		from T_YhInfo yh ,T_RbInfo rb ,T_QgInfo qg,T_JzqInfo jzq 
		where yh.RbAd=rb.RbAd  and qg.JzqID=jzq.JzqID and rb.QgID=qg.QgID  and rb.RbAd=#{rbAd}
		</select>
		<select id="findBzxx" resultMap="rb" parameterType="Rb">
		 select yh.Bz,yh.XqName,yh.BuildNo,yh.CellNo,yh.HouseNO from T_YhInfo yh,T_RbInfo rb where yh.RbAd=rb.RbAd and yh.XqName=#{xqName} and yh.RbLyName=#{rbLyName} and yh.CellNo=#{cellNO} and yh.HouseNO=#{houseNO}
		</select>
		<update id="Upbz" parameterType="Rb">
		 update T_YhInfo set Bz=#{bz} where XqName=#{xqName} and RbLyName=#{rbLyName} and CellNo=#{cellNO} and HouseNO=#{houseNO}
		</update>
		<select id="SelRbAd" resultMap="rb" parameterType="Rb">
		select RbAd from T_YhInfo where XqName=#{xqName} and RbLyName=#{rbLyName} and CellNo=#{cellNO} and HouseNO=#{houseNO}
		</select>
		<select id="SelRb" resultMap="rb" parameterType="Rb">
	    select r.Diff_Tmp,r.Energy,r.In_Tmp,r.Out_Tmp,r.Flow,r.Power,r.Diff_Tmp,r.OperTime,r.RecordTime
	    from T_RbHistory r where r.RbAd=#{RbAd} 
	    and r.RecordTime > CONVERT(varchar,#{recordTime}, 120)
	   	order by RecordTime
		</select>
		<select id="findRbHis" resultMap="rb" parameterType="Rb">
		 Select top 1500
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.ResNum,
		y.RbLyName,
		y.Rbfl,
		y.RbLyName,
		r.RbType,
		r.RbAd,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.status,
		r.RbType,
		y.Bz
		from T_YhInfo y,T_RbHistory r
		
		where y.RbAd=r.RbAd and y.Rbfl=0
		and r.RecordTime &gt;=#{recordTime1}
		and r.RecordTime &lt;=#{recordTime2}
		</select>
		<update id="upRbbz" parameterType="Rb">
		update T_YhInfo set Bz=#{bz} where RbAd=#{rbAd}
		</update>
		<select id="JrCb" resultMap="rb" parameterType="Rb">
			 Select top 1000
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.ResNum,
		y.Rbfl,
		y.RbLyName,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.status,
		r.RbType,
		y.Bz

		from T_YhInfo y,T_RbInfo r
		where y.RbAd=r.RbAd and Rbfl=0 
		<if test="xqName!='--选择小区名称--' and xqName!=''">
		  and  XqName=#{xqName}
		</if>
	<!-- 	<if test="buildNO!=0 and buildNO!=''">
		  and  BuildNO=#{buildNO}
		</if> -->
			<if test="rbLyName!=null and rbLyName!=''">
		  and  RbLyName=#{rbLyName}
		</if>
		<if test="cellNo!=null and cellNo!=''">
		  and  CellNO=#{cellNo}
		</if>   <!--  大于等于 -->
		  and r.RecordTime &gt;=#{time}
		<!--  and datediff(DD,#{time},getdate())=0 -->
		</select>
		<select id="JrWCb" resultMap="rb" parameterType="Rb">
		Select top 1500
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.ResNum,
		y.Rbfl,
		y.RbLyName,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.status,
		r.RbType,
		y.Bz
		from T_YhInfo y,T_RbInfo r
		where y.RbAd=r.RbAd  and  y.Rbfl=0 
		<if test="xqName!='--选择小区名称--' and xqName!=''">
		  and  XqName=#{xqName}
		</if>
			<if test="rbLyName!=null and rbLyName!=''">
		  and  RbLyName=#{rbLyName}
		</if>
		<!-- <if test="buildNO!=0 and buildNO!=''">
		  and  BuildNO=#{buildNO}
		</if> -->
		<if test="cellNo!=null and cellNo!=''">
		  and  CellNO=#{cellNo}
		</if>    <!-- 小于等于 -->
		  and r.RecordTime &lt;=#{time}
		</select>
		
		
		<update id="updateRbAd">
		update T_RbInfo set RbAd=#{xrbAd} where RbAd=#{rbAd} 
		</update>
		<update id="updateYhRbAd">
		 update T_YhInfo set RbAd=#{xrbAd} where RbAd=#{rbAd}
		</update>
		<insert id="InsertRbId">
		 insert into T_RbId (RbAd,RecordTime) values(#{rbAd},#{recordTime})
		</insert>
		<select id="DeleteRbId">
		delete from T_RbId
		</select>
		<select id="findRbId" resultMap="rb">
		select * from T_RbId order by RecordTime desc
		</select>
		<select id="findRbflByQgId" resultMap="rb">
		select distinct y.Rblb,r.QgID,j.JzqIP,j.JzqPort from T_RbInfo r,T_YhInfo y,T_QgInfo q,T_JzqInfo j where r.RbAd=y.RbAd and q.QgID=r.QgID and q.JzqID=j.JzqID and r.QgId=#{qgId} 
		</select>
		<select id="findRbGzxx" resultMap="rb" parameterType="Rb">
		Select top 4000
        y.ID,
		y.YhName,
		y.XqName,
		y.BuildNO,
		y.CellNO,
		y.HouseNO,
		y.Rbfl,
		y.RbLyName,
		y.ResNum,
		r.RbType,
		r.RbAd,
		r.QgId,
		r.Energy,
		r.EnergyUnit,
		r.Power,
		r.Flow,
		r.In_Tmp,
		r.Out_Tmp,
		r.Diff_Tmp,
		r.OperTime,
		r.ErrCode,
		r.ReadMTime,
		r.RecordTime,
		r.EnergyLj,
		r.status,
		r.RbType,
		y.Bz
		from T_YhInfo y,T_RbInfo r
		where y.RbAd=r.RbAd  and  y.Rbfl=0 and r.status=#{status}
		order by   xqName,BuildNO ,CellNO ,HouseNO ,RecordTime desc
		</select>
		<!-- 获取AZWZ 为1的热表用户信息 -->
		<select id="findRbYh" resultMap="rb">
		select y.RbAd,y.Rblb from T_YhInfo y,T_RbInfo r where y.RbAd=r.RbAd  and QgId=#{qgId}
		</select>
		<select  id="findRblb" resultMap="rb">
		select distinct y.Rblb from T_YhInfo y,T_RbInfo r where y.RbAd=r.RbAd  and QgId=#{qgId}
		</select>
</mapper>
